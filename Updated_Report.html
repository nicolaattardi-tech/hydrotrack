<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HydroTrack - Report</title>
    <link rel="stylesheet" href="global.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-container {
            padding: 15px;
        }

        /* --- Graph Section --- */
        .graph-card {
            background: white;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            min-height: 200px;
        }

        /* --- Filter Section --- */
        .filter-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
        }

/* --- Log Cards Section --- */
        .history-log {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 40px;
        }

        .day-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 6px; /* Slightly more breathing room */
        }

        .day-card.goal-met {
            background-color: #F0F7FF;
            border: 1px solid var(--dark-blue);
        }
        
        .day-card.goal-met .card-line-data .data-percent {
            margin-left: auto;
            font-weight: 700;
            color: var(--dark-blue);
            font-size: 0.9rem;
        }

        .card-line-date {
            font-weight: 800;
            font-size: 1.1rem;
            color: #111;
            margin-bottom: 6px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 4px;
        }

        /* The "Tabbed" Row Logic */
        .card-line-data {
            display: flex; /* Allows horizontal alignment */
            align-items: center;
            font-size: 0.85rem;
            color: #555;
        }

        /* This creates the 'Tab' effect */
        .card-line-data .data-label {
            width: 85px; /* Fixed width for all names */
            font-weight: 700;
            color: #333;
            flex-shrink: 0;
        }

        .card-line-data .data-value {
            font-weight: 400;
            flex-grow: 1;
        }

        /* Percentage pushed to the far right */
        .card-line-data .data-percent {
            margin-left: auto;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .hidden-row {
            display: none !important;
        }

        .see-more-btn {
            margin: 20px auto;
            display: block;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            /* This pulls directly from your global variables */
            background-color: var(--light-blue);
            color: var(--bg-white);
            /* Assuming you want dark text on light blue */
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .see-more-btn:active {
            opacity: 0.7;
            /* Gives visual feedback when tapped */
        }

        /*checkboxes styling */
        /* 1. Hide the default checkbox completely */
        .filter-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* 2. Create the custom box */
        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            position: relative;
            padding-left: 25px;
            /* Space for the custom box */
        }

        .checkmark {
            position: absolute;
            left: 0;
            height: 18px;
            /* Box size */
            width: 18px;
            background-color: var(--bg-white);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        /* 3. Link colors to specific IDs */
        #filterWater+.checkmark {
            border: 2px solid var(--chart-water);
        }

        #filterT1+.checkmark {
            border: 2px solid var(--chart-t1);
        }

        #filterT2+.checkmark {
            border: 2px solid var(--chart-t2);
        }

        /* 4. When checked: Fill background and show white tick */
        #filterWater:checked+.checkmark {
            background-color: var(--chart-water);
        }

        #filterT1:checked+.checkmark {
            background-color: var(--chart-t1);
        }

        #filterT2:checked+.checkmark {
            background-color: var(--chart-t2);
        }

        /* 5. Create the checkmark tick (White and Thin) */
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left:4px;
            top: 1px;
            width: 4px;
            /* Thinner width */
            height: 9px;
            /* Height of the tick */
            border: solid white;
            border-width: 0 3px 3px 0;
            /* Thickness of the white line */
            transform: rotate(45deg);
        }

        #filterWater:checked+.checkmark:after,
        #filterT1:checked+.checkmark:after,
        #filterT2:checked+.checkmark:after {
            display: block;
        }
    </style>
</head>

<body>
    <header class="pwa-header">
        <div class="brand">
            <img src="icon-192.png" alt="Logo">
            <span>Report</span>
        </div>
        <a href="index.html" class="header-action">
            <svg viewBox="0 0 24 24">
                <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
            </svg>
        </a>
    </header>

    <div class="report-container">
        <div class="graph-card">
            <canvas id="waterChart"></canvas>
        </div>

        <div class="filter-container">
            <label class="filter-item"><input type="checkbox" id="filterWater" checked onchange="updateView()">
                <span class="checkmark"></span>
                Water
            </label>
            <label class="filter-item"><input type="checkbox" id="filterT1" checked onchange="updateView()">
                <span class="checkmark"></span>
                <span id="labelT1">Tracker 1</span>
            </label>
            <label class="filter-item"><input type="checkbox" id="filterT2" checked onchange="updateView()">
                <span class="checkmark"></span>
                <span id="labelT2">Tracker 2</span>
            </label>
        </div>

        <div class="history-log" id="logContainer"></div>
    </div>

    <script>
        // Robust date parser to handle browser variations (/, ., or -)
        const parseDate = (str) => {
            const parts = str.split(/[./-]/);
            if (parts.length !== 3) return new Date();
            // Check if format is M/D/Y (like your screenshot) or D.M.Y
            if (parseInt(parts[0]) > 12) { // Likely D.M.Y
                return new Date(parts[2], parts[1] - 1, parts[0]);
            } else { // Likely M/D/Y
                return new Date(parts[2], parts[0] - 1, parts[1]);
            }
        };
        
        let state = JSON.parse(localStorage.getItem('waterTrackerData')) || { history: {} };
        let history = state.history;
        let chart = null;

        document.getElementById('labelT1').innerText = state.t1Name || "Creatine";
        document.getElementById('labelT2').innerText = state.t2Name || "Protein";

        function renderGraph() {
    const ctx = document.getElementById('waterChart').getContext('2d');
    const style = getComputedStyle(document.documentElement);
    
    // 1. Fetch Colors from CSS Variables
    const colorWater = style.getPropertyValue('--chart-water').trim();
    const colorT1 = style.getPropertyValue('--chart-t1').trim();
    const colorT2 = style.getPropertyValue('--chart-t2').trim();

    // 2. Capture Checkbox States (The missing piece!)
    const showWater = document.getElementById('filterWater').checked;
    const showT1 = document.getElementById('filterT1').checked;
    const showT2 = document.getElementById('filterT2').checked;

    // 3. Prepare Data (Last 10 Days)
    const sortedDates = Object.keys(history).sort((a, b) => parseDate(a) - parseDate(b)).slice(-10);

    // 4. Calculate Smart Ceiling (Dynamic Height)
    const maxValInView = Math.max(
        ...sortedDates.map(d => history[d].intake || 0),
        ...sortedDates.map(d => history[d].target || 0)
    );
    const WATER_MAX = Math.ceil((maxValInView + 500) / 1000) * 1000;

    // 5. Date Formatting (DD.MM.YY)
    const labels = sortedDates.map(d => {
        const dateObj = parseDate(d);
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = String(dateObj.getFullYear()).slice(-2);
        return `${day}.${month}.${year}`;
    });

    // 6. Tracker Scaling Logic
    const getMultiplier = (key) => {
        const values = sortedDates.map(d => history[d][key] || 0);
        const maxVal = Math.max(...values);
        if (maxVal <= 0) return 0;
        return (WATER_MAX * 0.7) / maxVal;
    };

    const t1Multiplier = getMultiplier('t1Value');
    const t2Multiplier = getMultiplier('t2Value');

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Water',
                    data: sortedDates.map(d => history[d].intake),
                    borderColor: colorWater,
                    backgroundColor: colorWater,
                    borderWidth: 1.5,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0.4,
                    hidden: !showWater // <--- Restores Filtering
                },
                {
                    label: state.t1Name || 'Tracker 1',
                    data: sortedDates.map(d => (history[d].t1Value || 0) * t1Multiplier),
                    borderColor: colorT1,
                    backgroundColor: colorT1,
                    borderWidth: 1.5,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0.4,
                    hidden: !showT1 // <--- Restores Filtering
                },
                {
                    label: state.t2Name || 'Tracker 2',
                    data: sortedDates.map(d => (history[d].t2Value || 0) * t2Multiplier),
                    borderColor: colorT2,
                    backgroundColor: colorT2,
                    borderWidth: 1.5,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0.4,
                    hidden: !showT2 // <--- Restores Filtering
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'nearest',
                intersect: true
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    displayColors: false,
                    callbacks: {
                        title: (context) => context[0].label,
                        label: function (context) {
                            const date = sortedDates[context.dataIndex];
                            const idx = context.datasetIndex;
                            if (idx === 0) return `Water: ${history[date].intake}ml`;
                            if (idx === 1) return `${state.t1Name || 'T1'}: ${history[date].t1Value}`;
                            if (idx === 2) return `${state.t2Name || 'T2'}: ${history[date].t2Value}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    display: false,
                    min: 0,
                    max: WATER_MAX
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 9 } }
                }
            }
        }
    });
}

        // 1. Define this OUTSIDE the function so it persists
        let itemsToShow = 10;

        function renderLog() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';

            const showWater = document.getElementById('filterWater').checked;
            const showT1 = document.getElementById('filterT1').checked;
            const showT2 = document.getElementById('filterT2').checked;

            const allSortedDates = Object.keys(history).sort((a, b) => parseDate(b) - parseDate(a));
            const datesToRender = allSortedDates.slice(0, itemsToShow);

            datesToRender.forEach(date => {
                const entry = history[date];
                const percent = Math.round((entry.intake / entry.target) * 100);
                const isMet = entry.intake >= entry.target;

                const card = document.createElement('div');
                card.className = `day-card ${isMet ? 'goal-met' : ''}`;

                card.innerHTML = `
                    <div class="card-line-date">${date}</div>
                    
                    <div class="card-line-data ${showWater ? '' : 'hidden-row'}">
                        <span class="data-label">Water:</span>
                        <span class="data-value">${entry.intake}ml / ${entry.target}ml</span>
                        <span class="data-percent">${percent}%</span>
                    </div>
                    
                    <div class="card-line-data ${showT1 ? '' : 'hidden-row'}">
                        <span class="data-label">${entry.t1Name || 'Tracker 1'}:</span>
                        <span class="data-value">${entry.t1Value || 0} units</span>
                    </div>

                    <div class="card-line-data ${showT2 ? '' : 'hidden-row'}">
                        <span class="data-label">${entry.t2Name || 'Tracker 2'}:</span>
                        <span class="data-value">${entry.t2Value || 0} units</span>
                    </div>
                `;
                container.appendChild(card);
            });

            if (allSortedDates.length > itemsToShow) {
                const btn = document.createElement('button');
                btn.innerText = 'See More';
                btn.className = 'see-more-btn';
                btn.onclick = () => { itemsToShow += 10; renderLog(); };
                container.appendChild(btn);
            }
        }

        // Initialize the view
        updateView();

        function updateView() {
            renderGraph();
            renderLog();
        }

        updateView();
    </script>
</body>

</html>